### 看源码的技巧

1. 听 B站 课程

2. 使用 AI 画出流程图

3. 使用 AI 添加一些中文注释

## Vue2 完整流程图

### 1. **Vue实例初始化流程**

```mermaid
graph TD
    A[new Vue] --> B[Vue构造函数]
    B --> C[调用_init方法]
    C --> D[合并配置选项]
    D --> E[初始化生命周期]
    E --> F[初始化事件]
    F --> G[初始化渲染]
    G --> H[初始化数据]
    H --> I[初始化计算属性]
    I --> J[初始化监听器]
    J --> K[初始化provide/inject]
    K --> L[调用created钩子]
    L --> M[挂载到DOM]
    M --> N[调用mounted钩子]
```

### 2. **响应式系统流程**

```mermaid
graph TD
    A[data选项] --> B[observe函数]
    B --> C[创建Observer实例]
    C --> D{是否为数组?}
    D -->|是| E[劫持数组方法]
    D -->|否| F[遍历对象属性]
    E --> G[递归观察数组元素]
    F --> H[defineReactive]
    G --> I[设置__ob__属性]
    H --> I
    I --> J[创建Dep依赖收集器]
    J --> K[定义getter/setter]
    K --> L[getter收集依赖]
    K --> M[setter触发更新]
    L --> N[Dep.target存在?]
    N -->|是| O[dep.depend收集依赖]
    N -->|否| P[直接返回值]
    M --> Q[值是否改变?]
    Q -->|是| R[dep.notify通知更新]
    Q -->|否| S[不触发更新]
```

### 3. **依赖收集和更新流程**

```mermaid
graph TD
    A[模板编译] --> B[创建Watcher]
    B --> C[设置Dep.target]
    C --> D[执行getter函数]
    D --> E[访问响应式数据]
    E --> F[触发getter]
    F --> G[收集依赖到Dep]
    G --> H[清除Dep.target]
    H --> I[数据变化]
    I --> J[触发setter]
    J --> K[dep.notify]
    K --> L[遍历所有Watcher]
    L --> M[调用watcher.update]
    M --> N[加入更新队列]
    N --> O[nextTick执行]
    O --> P[执行watcher.run]
    P --> Q[重新渲染]
```

### 4. **虚拟DOM渲染流程**

```mermaid
graph TD
    A[模板] --> B[编译成render函数]
    B --> C[执行render函数]
    C --> D[生成VNode]
    D --> E[创建组件VNode]
    E --> F[创建元素VNode]
    F --> G[创建文本VNode]
    G --> H[VNode树构建完成]
    H --> I[调用_update方法]
    I --> J{是否存在旧VNode?}
    J -->|是| K[patch对比更新]
    J -->|否| L[直接创建DOM]
    K --> M[对比节点类型]
    M --> N{节点类型相同?}
    N -->|是| O[对比属性]
    N -->|否| P[替换节点]
    O --> Q[对比子节点]
    Q --> R[递归patch]
    P --> S[创建新DOM]
    L --> S
    S --> T[插入到页面]
```

### 5. **组件生命周期流程**

```mermaid
graph TD
    A[组件创建] --> B[beforeCreate]
    B --> C[初始化data/props]
    C --> D[created]
    D --> E[beforeMount]
    E --> F[编译模板]
    F --> G[创建VNode]
    G --> H[渲染DOM]
    H --> I[mounted]
    I --> J[数据变化]
    J --> K[beforeUpdate]
    K --> L[重新渲染]
    L --> M[updated]
    M --> N[组件销毁]
    N --> O[beforeDestroy]
    O --> P[清理工作]
    P --> Q[destroyed]
```

### 6. **事件系统流程**

```mermaid
graph TD
    A[模板事件绑定] --> B[编译时收集]
    B --> C[运行时绑定]
    C --> D[创建事件处理器]
    D --> E[绑定到DOM元素]
    E --> F[用户触发事件]
    F --> G[DOM事件触发]
    G --> H[Vue事件处理器]
    H --> I[执行用户回调]
    I --> J[更新数据]
    J --> K[触发响应式更新]
```

### 7. **计算属性和监听器流程**

```mermaid
graph TD
    A[计算属性定义] --> B[创建计算属性Watcher]
    A --> C[监听器定义]
    C --> D[创建监听器Watcher]
    B --> E[设置lazy: true]
    D --> F[设置user: true]
    E --> G[首次访问时计算]
    F --> H[监听数据变化]
    G --> I[缓存计算结果]
    H --> I
    I --> J[返回缓存值]
    I --> K[执行回调函数]
```

### 8. **异步更新队列流程**

```mermaid
graph TD
    A[数据变化] --> B[触发setter]
    B --> C[dep.notify]
    C --> D[watcher.update]
    D --> E{是否已加入队列?}
    E -->|否| F[加入更新队列]
    E -->|是| G[跳过]
    F --> H[设置pending标志]
    H --> I[nextTick]
    I --> J[微任务队列]
    J --> K[执行flushSchedulerQueue]
    K --> L[按ID排序Watcher]
    L --> M[执行before钩子]
    M --> N[执行watcher.run]
    N --> O[执行updated钩子]
    O --> P[清空队列]
    P --> Q[重置pending标志]
```

### 9. **指令系统流程**

```mermaid
graph TD
    A[模板指令] --> B[编译时解析]
    B --> C[生成指令对象]
    C --> D[创建指令实例]
    D --> E[调用bind钩子]
    E --> F[DOM元素绑定]
    F --> G[数据变化]
    G --> H[调用update钩子]
    H --> I[更新DOM]
    I --> J[组件销毁]
    J --> K[调用unbind钩子]
    K --> L[清理绑定]
```

### 10. **插槽系统流程**

```mermaid
graph TD
    A[父组件模板] --> B[定义插槽内容]
    B --> C[编译成函数]
    C --> D[传递给子组件]
    D --> E[子组件接收]
    E --> F[渲染插槽内容]
    F --> G[作用域插槽]
    G --> H[传递数据给父组件]
    H --> I[父组件使用数据]
```

## 关键流程说明

### **初始化阶段**
1. **构造函数**：`new Vue()` 调用 `_init` 方法
2. **选项合并**：合并用户选项和默认选项
3. **生命周期初始化**：设置各种钩子函数
4. **数据初始化**：调用 `initData` 开始响应式处理

### **响应式阶段**
1. **observe**：为数据创建观察者
2. **defineReactive**：定义getter/setter
3. **依赖收集**：在getter中收集依赖
4. **更新触发**：在setter中触发更新

### **渲染阶段**
1. **模板编译**：将模板编译成render函数
2. **VNode创建**：执行render函数生成虚拟节点
3. **DOM更新**：通过patch算法更新真实DOM

### **更新阶段**
1. **数据变化**：触发setter
2. **依赖通知**：通知所有相关Watcher
3. **队列管理**：将更新任务加入队列
4. **异步执行**：在下一个tick中执行更新

这个流程图展示了Vue2从初始化到渲染的完整生命周期，每个阶段都有明确的职责和流程。理解这些流程有助于更好地掌握Vue2的工作原理！

