# Vue2 入口文件分析

## 1. 主入口文件 - src/core/index.ts

让我们先查看Vue2的主入口文件：

```typescript
// src/core/index.ts
import Vue from './instance/index'
import { initGlobalAPI } from './global-api/index'
import { isServerRendering } from 'core/util/env'
import { FunctionalRenderContext } from 'core/vdom/create-functional-component'
import { version } from 'v3'

// 初始化全局API
initGlobalAPI(Vue)

// 设置Vue版本
Vue.version = version

// 导出Vue构造函数
export default Vue
```

### 关键点分析：

1. **Vue构造函数**：从`./instance/index`导入Vue构造函数
2. **全局API初始化**：通过`initGlobalAPI`初始化全局API
3. **版本信息**：设置Vue版本号

## 2. Vue实例创建 - src/core/instance/index.ts

这是Vue构造函数的核心文件：

```typescript
// src/core/instance/index.ts
import { initMixin } from './init'
import { stateMixin } from './state'
import { renderMixin } from './render'
import { eventsMixin } from './events'
import { lifecycleMixin } from './lifecycle'
import { warn } from '../util/index'
import type { Component } from 'types/component'

// Vue构造函数
function Vue(options) {
  if (__DEV__ && !(this instanceof Vue)) {
    warn('Vue is a constructor and should be called with the `new` keyword')
  }
  this._init(options)
}

// 初始化混入
initMixin(Vue)
// 状态混入
stateMixin(Vue)
// 事件混入
eventsMixin(Vue)
// 生命周期混入
lifecycleMixin(Vue)
// 渲染混入
renderMixin(Vue)

export default Vue as typeof Vue & {
  cid: number
  options: Record<string, any>
  super: typeof Vue | undefined
  extend: (options: Record<string, any>) => typeof Vue
  nextTick: typeof nextTick
  set: typeof set
  delete: typeof del
  use: (plugin: Plugin) => typeof Vue
  mixin: (mixin: Record<string, any>) => typeof Vue
  compile: (template: string) => { render: Function; staticRenderFns: Array<Function> }
  version: string
}
```

### 关键点分析：

1. **构造函数**：Vue是一个构造函数，必须用`new`调用
2. **初始化**：调用`this._init(options)`进行初始化
3. **混入模式**：通过多个mixin函数扩展Vue原型

## 3. 初始化过程 - src/core/instance/init.ts

让我们查看`_init`方法的实现：

```typescript
// src/core/instance/init.ts
export function initMixin(Vue: typeof Component) {
  Vue.prototype._init = function (options?: Record<string, any>) {
    const vm: Component = this
    // a uid
    vm._uid = uid++

    let startTag, endTag
    /* istanbul ignore if */
    if (__DEV__ && config.performance && mark) {
      startTag = `vue-perf-start:${vm._uid}`
      endTag = `vue-perf-end:${vm._uid}`
      mark(startTag)
    }

    // a flag to mark this as a Vue instance without having to do instanceof
    // check
    vm._isVue = true
    // avoid instances from being observed
    vm.__v_skip = true
    // effect scope
    vm._scope = new EffectScope(true /* detached */)
    vm._scope._vm = true
    // merge options
    if (options && options._isComponent) {
      // optimize internal component instantiation
      // since dynamic options merging is pretty slow, and none of the
      // internal component options needs special treatment.
      initInternalComponent(vm, options as any)
    } else {
      vm.$options = mergeOptions(
        resolveConstructorOptions(vm.constructor as any),
        options || {},
        vm
      )
    }
    /* istanbul ignore else */
    if (__DEV__) {
      initProxy(vm)
    } else {
      vm._renderProxy = vm
    }
    // expose real self
    vm._self = vm
    initLifecycle(vm)
    initEvents(vm)
    initRender(vm)
    callHook(vm, 'beforeCreate', undefined, false /* setContext */)
    initInjections(vm) // resolve injections before data/props
    initState(vm)
    initProvide(vm) // resolve provide after data/props
    callHook(vm, 'created')

    /* istanbul ignore if */
    if (__DEV__ && config.performance && mark) {
      vm._name = formatComponentName(vm, false)
      mark(endTag!)
      measure(`vue ${vm._name} init`, startTag!, endTag!)
    }

    if (vm.$options.el) {
      /* eslint-disable-next-line no-console */
      console.warn(
        `[Vue warn]: new Vue() no longer accepts an el option. ` +
          `Use vm.$mount(el) instead.`
      )
      vm.$mount(vm.$options.el)
    }
  }
}
```

### 初始化步骤：

1. **设置实例标识**：`vm._uid`、`vm._isVue`
2. **合并选项**：合并构造函数选项和实例选项
3. **初始化代理**：设置渲染代理
4. **初始化生命周期**：`initLifecycle`
5. **初始化事件**：`initEvents`
6. **初始化渲染**：`initRender`
7. **调用beforeCreate钩子**
8. **初始化注入**：`initInjections`
9. **初始化状态**：`initState`（data、props、methods等）
10. **初始化提供**：`initProvide`
11. **调用created钩子**
12. **挂载**：如果提供了el选项，自动挂载

## 4. 状态初始化 - src/core/instance/state.ts

状态初始化是Vue响应式系统的核心：

```typescript
// src/core/instance/state.ts
export function initState(vm: Component) {
  const opts = vm.$options
  if (opts.props) initProps(vm, opts.props)
  if (opts.methods) initMethods(vm, opts.methods)
  if (opts.data) {
    initData(vm)
  } else {
    const ob = observe((vm._data = {}))
    ob && ob.vmCount++
  }
  if (opts.computed) initComputed(vm, opts.computed)
  if (opts.watch && opts.watch !== nativeWatch) {
    initWatch(vm, opts.watch)
  }
}
```

### 状态初始化顺序：

1. **Props**：初始化props
2. **Methods**：初始化methods
3. **Data**：初始化data（响应式处理）
4. **Computed**：初始化computed
5. **Watch**：初始化watch

## 5. 总结

Vue2的入口文件设计体现了以下特点：

1. **模块化设计**：通过mixin模式扩展功能
2. **渐进式增强**：按需初始化不同功能
3. **生命周期管理**：在适当时机调用生命周期钩子
4. **响应式系统**：在状态初始化时建立响应式连接

这种设计使得Vue2具有良好的可扩展性和维护性。
